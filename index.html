<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content= "width=device-width, initial-scale=1.0"> 
    <title>Soar, Raven, Soar</title>
    <link href="media/style.css" rel="stylesheet"></head>
<body>

<article>
  <section>
    <h1>Soar, Raven, Soar</h1>
    
    <span id=score></span>
    
    <canvas id="myCanvas" width="480" height="400"></canvas>

    Difficulty: <input name=difficulty value=2 size=5></input>

    <button id=restart>Restart</button>
    <button id=pause>Pause</button>
    <button id=step>Step</button>
    
    <footer>
      <span>Built with ❤️ using code from <a href="https://developer.mozilla.org/en-US/docs/Games/Tutorials/2D_Breakout_game_pure_JavaScript">Mozilla</a> and MDN contributors.</span>
    </footer>
  </section>
</article>

<script>
  var x, y, dx, dy, paddleX;
  var canvas = document.getElementById("myCanvas");
  var ctx = canvas.getContext("2d");
  var ravenHitbox = 12;
  var paddleHeight = 10;
  var paddleWidth = 75;
  var brickRowCount = 8;
  var brickColumnCount = 6;
  var brickWidth = 46;
  var brickHeight = 20;
  var brickPadding = 10;
  var brickOffsetTop = 30
  var brickOffsetLeft = 20;
  var color = "#f57920";
  var ravens_harmed = 0;
  var ravens_freed = 0;
  var paused = true;
  var bricks = [];

  function load_image(src) {
    img = new Image()
    img.src = src
    return img
  }

  raven_right = load_image('media/raven-right.png')

  function togglePause() {
    paused = !paused
    document.querySelector('#pause').innerHTML = paused ? 'Resume' : 'Pause'
    document.querySelector('#step').style.display = paused ? 'inline' : 'none'
    draw()
  }
  document.querySelector('#pause').addEventListener('click', togglePause)

  document.querySelector('#step').addEventListener('click', () => {
    if (paused) { draw() }
    console.clear()
    console.log(`x: ${x}\ndx: ${dx}\ny: ${y}\ndy: ${dy}`)
  })

  function restart() {
    let difficulty = eval(document.querySelector('input[name=difficulty]').value)
  
    x = canvas.width/2;
    y = canvas.height-30;
    paddleX = (canvas.width-paddleWidth)/2;

    dx=0
    dy=0

    for(var c=0; c<brickColumnCount; c++) {
      bricks[c] = [];
      for(var r=0; r<brickRowCount; r++) {
        bricks[c][r] = { x: 0, y: 0, status: 1 };
      }
    }

    clearTimeout(restart.timer)
    restart.timer = setTimeout(() => {
      dx = difficulty * (2.5 + Math.random()) / 4;
      dy = -(difficulty * difficulty - dx * dx)
    }, 1000)
  }
  document.querySelector('#restart').addEventListener('click', restart)

  function movePaddle(e) {
    if (e.targetTouches) { e = e.targetTouches[0] }
    
    var relativeX = (e.clientX - canvas.offsetLeft) * (canvas.width / canvas.offsetWidth);
    if(relativeX > 0 && relativeX < canvas.width) {
      paddleX = relativeX - paddleWidth/2;
    }
  }
  document.addEventListener("mousemove", movePaddle, false);
  document.addEventListener("touchmove", movePaddle, false);

  function drawRaven() {
    ctx.drawImage(raven_right, x - 38, y - 12);
  }

  function drawPaddle() {
    ctx.beginPath();
    ctx.rect(paddleX, canvas.height-paddleHeight, paddleWidth, paddleHeight);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.closePath();
  }
  
  function drawBricks() {
    for(var c=0; c<brickColumnCount; c++) {
      for(var r=0; r<brickRowCount; r++) {
        if(bricks[c][r].status == 1) {
          var brickX = (r*(brickWidth+brickPadding))+brickOffsetLeft;
          var brickY = (c*(brickHeight+brickPadding))+brickOffsetTop;
          bricks[c][r].x = brickX;
          bricks[c][r].y = brickY;
          ctx.beginPath();
          ctx.rect(brickX, brickY, brickWidth, brickHeight);
          ctx.fillStyle = color;
          ctx.fill();
          ctx.closePath();
        }
      }
    }
  }
  
  function drawScore() {
    document.querySelector("#score").textContent = 'Ravens Freed: ' + ravens_freed + ' Ravens Harmed: ' + ravens_harmed 
  }

  function collisionDetection() {
    for(var c=0; c<brickColumnCount; c++) {
      for(var r=0; r<brickRowCount; r++) {
        var b = bricks[c][r];
        if(b.status == 1) {
          if(x > b.x && x < b.x+brickWidth && y > b.y && y < b.y+brickHeight) {
            dy = -dy;
            b.status = 0;
          }
        }
      }
    }
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    collisionDetection();

    if(x + dx > canvas.width-ravenHitbox || x + dx < ravenHitbox) {
      dx = -dx;
    }
    
    if(y < -100) {
      ravens_freed++
      restart()
    } else if (y > canvas.height + 64) {
      ravens_harmed++
      restart()
    } else if(y > canvas.height-ravenHitbox && y < canvas.height+ravenHitbox && 
              x > paddleX && x < paddleX + paddleWidth && dy > 0 ) {
        dy = -dy;
    }

    x += dx;
    y += dy;

    drawBricks();
    drawRaven();
    drawPaddle();
    drawScore();
    
    if (!paused) {
      requestAnimationFrame(draw);
    }
  }

  restart()
  togglePause()
</script>

</body>
</html>